pipeline {
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
spec:
  serviceAccountName: jenkins
  nodeSelector:
    cloud.google.com/gke-nodepool: build-pool
  tolerations:
  - key: "node.kubernetes.io/not-ready"
    operator: "Exists"
    effect: "NoSchedule"
  - key: "ToBeDeletedByClusterAutoscaler"
    operator: "Exists"
    effect: "NoSchedule"
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:debug
    command: ["sleep", "infinity"]
    resources:
      requests: { memory: "1Gi", cpu: "500m" }
      limits:   { memory: "2Gi", cpu: "1000m" }
    volumeMounts:
    - name: workspace
      mountPath: /workspace
  - name: gcloud
    image: google/cloud-sdk:latest
    command: ["sleep", "infinity"]
    resources:
      requests: { memory: "512Mi", cpu: "250m" }
      limits:   { memory: "1Gi", cpu: "500m" }
    volumeMounts:
    - name: workspace
      mountPath: /workspace
  - name: trivy
    image: aquasec/trivy:latest
    command: ["sleep", "infinity"]
    volumeMounts:
    - name: workspace
      mountPath: /workspace
    - name: security-reports
      mountPath: /reports
  - name: dependency-check
    image: owasp/dependency-check:latest
    command: ["sleep", "infinity"]
    volumeMounts:
    - name: workspace
      mountPath: /workspace
    - name: security-reports
      mountPath: /reports
  - name: safety
    image: python:3.9-slim
    command: ["sleep", "infinity"]
    volumeMounts:
    - name: workspace
      mountPath: /workspace
    - name: security-reports
      mountPath: /reports
  - name: zap
    image: zaproxy/zap-stable
    command: ["sleep", "infinity"]
    volumeMounts:
    - name: workspace
      mountPath: /workspace
    - name: security-reports
      mountPath: /zap/wrk
  volumes:
  - name: workspace
    emptyDir: {}
  - name: security-reports
    emptyDir: {}
'''
        }
    }

    environment {
        PROJECT_ID          = 'e-shop-deploy'
        REGION              = 'europe-west1'
        REPO                = 'e-shop-repo'
        TAG                 = "${BUILD_NUMBER}"
        DB_PRODUCT_NAME     = "e_shop_product_db"
        DB_USER_NAME        = "e_shop_auth_db"
        DB_CART_NAME        = "e_shop_cart_db"
        DB_TRANSACTION_NAME = "e_shop_transaction_db"
    }

    stages {
        stage('Checkout') { 
            steps { 
                checkout scm 
            } 
        }

        stage('Build & Push') {
            steps {
                container('kaniko') {
                    withCredentials([file(credentialsId: 'gcp-sa-json', variable: 'GC_KEY')]) {
                        script {
                            def images = [
                                [df: 'e-commerce-master/Dockerfile.backend',        name: 'ecommerce-backend'],
                                [df: 'e-commerce-front-master/dockerfile.frontend', name: 'ecommerce-frontend'],
                                [df: 'recommendation-service/Dockerfile.recommendation', name: 'recommendation-api'],
                                [df: 'e-commerce-master/Dockerfile.user',          name: 'user-service',       env: [ "DB_NAME=${DB_USER_NAME}" ]],
                                [df: 'e-commerce-master/Dockerfile.product',       name: 'product-service',    env: [ "DB_NAME=${DB_PRODUCT_NAME}" ]],
                                [df: 'e-commerce-master/Dockerfile.transaction',   name: 'transaction-service', env: [ "DB_NAME=${DB_TRANSACTION_NAME}" ]]
                            ]

                            images.each { img ->
                                def envVars = img.env ? img.env.collect { k -> "--build-arg ${k}" }.join(' ') : ''
                                sh """
                                    export GOOGLE_APPLICATION_CREDENTIALS=\${GC_KEY}
                                    /kaniko/executor \\
                                      --context=. \\
                                      --dockerfile=${img.df} \\
                                      --ignore-path=node_modules \\
                                      --ignore-path=.git \\
                                      --ignore-path=*.log \\
                                      --ignore-path=coverage \\
                                      --ignore-path=dist \\
                                      --destination=${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${img.name}:${TAG} \\
                                      --destination=${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${img.name}:latest \\
                                      --cache=true \\
                                      --cleanup \\
                                      --verbosity=info \\
                                      ${envVars}
                                """
                            }
                        }
                    }
                }
            }
        }

        stage('Security Scans') {
            parallel {
                stage('Trivy Container Scans') {
                    steps {
                        container('trivy') {
                            script {
                                def services = [
                                    'ecommerce-backend',
                                    'ecommerce-frontend', 
                                    'recommendation-api',
                                    'user-service',
                                    'product-service',
                                    'transaction-service'
                                ]

                                services.each { service ->
                                    try {
                                        echo "ğŸ” Scanning ${service} container with Trivy..."
                                        
                                        // Container vulnerability scan
                                        sh """
                                            trivy image \\
                                                --format json \\
                                                --output /reports/trivy-${service}-container.json \\
                                                --severity HIGH,CRITICAL \\
                                                --exit-code 0 \\
                                                ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${service}:${TAG}
                                        """
                                        
                                        // Generate human-readable report
                                        sh """
                                            trivy image \\
                                                --format table \\
                                                --output /reports/trivy-${service}-container.txt \\
                                                --severity HIGH,CRITICAL \\
                                                --exit-code 0 \\
                                                ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${service}:${TAG}
                                        """
                                        
                                        echo "âœ… Completed Trivy scan for ${service}"
                                    } catch (Exception e) {
                                        echo "âš ï¸ Trivy scan failed for ${service}: ${e.getMessage()}"
                                    }
                                }
                            }
                        }
                    }
                }

                stage('Filesystem Vulnerability Scans') {
                    steps {
                        script {
                            parallel([
                                'OWASP Dependency Check': {
                                    container('dependency-check') {
                                        try {
                                            echo "ğŸ” Running OWASP Dependency Check..."
                                            
                                            // Scan Node.js services
                                            sh """
                                                /usr/share/dependency-check/bin/dependency-check.sh \\
                                                    --scan /workspace/e-commerce-master \\
                                                    --scan /workspace/e-commerce-front-master \\
                                                    --format JSON \\
                                                    --format HTML \\
                                                    --out /reports \\
                                                    --project "E-Commerce-NodeJS" \\
                                                    --failOnCVSS 7 \\
                                                    --exclude "**/*.git/**" \\
                                                    --exclude "**/node_modules/**" \\
                                                    --exclude "**/dist/**" || true
                                            """
                                            
                                            echo "âœ… Completed OWASP Dependency Check"
                                        } catch (Exception e) {
                                            echo "âš ï¸ OWASP Dependency Check failed: ${e.getMessage()}"
                                        }
                                    }
                                },
                                'Python Safety Check': {
                                    container('safety') {
                                        try {
                                            echo "ğŸ” Running Python Safety check..."
                                            
                                            // Install safety
                                            sh 'pip install safety'
                                            
                                            // Check Python dependencies
                                            sh """
                                                cd /workspace/recommendation-service
                                                if [ -f requirements.txt ]; then
                                                    safety check \\
                                                        --json \\
                                                        --output /reports/safety-python-report.json \\
                                                        -r requirements.txt || true
                                                    
                                                    safety check \\
                                                        --output /reports/safety-python-report.txt \\
                                                        -r requirements.txt || true
                                                else
                                                    echo "No requirements.txt found for Python service"
                                                fi
                                            """
                                            
                                            echo "âœ… Completed Python Safety check"
                                        } catch (Exception e) {
                                            echo "âš ï¸ Python Safety check failed: ${e.getMessage()}"
                                        }
                                    }
                                },
                                'Trivy Filesystem Scan': {
                                    container('trivy') {
                                        try {
                                            echo "ğŸ” Running Trivy filesystem scans..."
                                            
                                            def paths = [
                                                [path: 'e-commerce-master', name: 'backend-services'],
                                                [path: 'e-commerce-front-master', name: 'frontend'],
                                                [path: 'recommendation-service', name: 'recommendation']
                                            ]
                                            
                                            paths.each { pathInfo ->
                                                sh """
                                                    trivy fs \\
                                                        --format json \\
                                                        --output /reports/trivy-fs-${pathInfo.name}.json \\
                                                        --severity HIGH,CRITICAL \\
                                                        --exit-code 0 \\
                                                        /workspace/${pathInfo.path}
                                                """
                                            }
                                            
                                            echo "âœ… Completed Trivy filesystem scans"
                                        } catch (Exception e) {
                                            echo "âš ï¸ Trivy filesystem scan failed: ${e.getMessage()}"
                                        }
                                    }
                                }
                            ])
                        }
                    }
                }
                
                stage('OWASP ZAP Security Scan') {
                    steps {
                        container('zap') {
                            script {
                                def zapTargets = [
                                    [name: 'ecommerce-backend', url: 'http://ecommerce-backend-service:80'],
                                    [name: 'user-service', url: 'http://user-service:3002'],
                                    [name: 'product-service', url: 'http://product-service:3003'],
                                    [name: 'transaction-service', url: 'http://transaction-service:3005'],
                                    [name: 'recommendation-api', url: 'http://recommendation-service:8001']
                                ]

                                zapTargets.each { target ->
                                    try {
                                        echo "ğŸ” Running ZAP baseline scan on ${target.name}..."
                                        
                                        sh """
                                            zap-baseline.py \\
                                                -t ${target.url} \\
                                                -r /zap/wrk/zap-${target.name}-report.html \\
                                                -w /zap/wrk/zap-${target.name}-warnings.md \\
                                                -J /zap/wrk/zap-${target.name}-report.json \\
                                                -I \\
                                                -d \\
                                                -T 5 || true
                                        """
                                        
                                        echo "âœ… Completed ZAP scan for ${target.name}"
                                    } catch (Exception e) {
                                        echo "âš ï¸ ZAP scan failed for ${target.name}: ${e.getMessage()}"
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        stage('Security Report Summary') {
            steps {
                script {
                    echo "ğŸ“Š Security Scan Summary:"
                    
                    // List all generated reports
                    sh '''
                        echo "=== Generated Security Reports ==="
                        find /reports -name "*.json" -o -name "*.html" -o -name "*.txt" | sort
                        
                        echo ""
                        echo "=== ZAP Reports ==="
                        find /zap/wrk -name "*.html" -o -name "*.json" -o -name "*.md" | sort || true
                    '''
                }
            }
            post {
                always {
                    // Archive all security reports
                    archiveArtifacts artifacts: 'reports/**/*', allowEmptyArchive: true
                    archiveArtifacts artifacts: 'zap/wrk/**/*', allowEmptyArchive: true
                    
                    // You can add publishHTML for better report viewing
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: false,
                        keepAll: true,
                        reportDir: 'reports',
                        reportFiles: '*.html',
                        reportName: 'Security Reports'
                    ])
                }
            }
        }

        stage('Deploy') {
            when {
                expression { 
                    return currentBuild.currentResult != 'FAILURE'
                }
            }
            steps {
                container('gcloud') {
                    withCredentials([file(credentialsId: 'gcp-sa-json', variable: 'KEY')]) {
                        sh '''
                            gcloud auth activate-service-account --key-file="$KEY"
                            gcloud container clusters get-credentials ecommerce-cluster-v2 \\
                                --zone=europe-west1-b --project=$PROJECT_ID
                            kubectl apply -f k8s/deployments/
                            kubectl apply -f k8s/services/
                        '''
                    }
                }
            }
        }
    }

    post {
        always  { 
            echo "ğŸ§¹ Cleaning upâ€¦"
            sh 'find /tmp -name "*security*" -type f -delete 2>/dev/null || true'
        }
        success { 
            echo "âœ… All images pushed to Artifact Registry and deployed."
            echo "ğŸ“Š Security scan reports available in Jenkins artifacts."
        }
        failure { 
            echo "âŒ Pipeline failed. Check logs above."
            echo "ğŸ” Review security scan results for critical vulnerabilities."
        }
        unstable {
            echo "âš ï¸ Pipeline completed with warnings. Check security scan results."
        }
    }
}