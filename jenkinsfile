pipeline {
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
spec:
  serviceAccountName: jenkins
  containers:
  - name: jnlp
    image: jenkins/inbound-agent:latest
    resources:
        requests:
            memory: "128Mi"
            cpu:    "50m"
        limits:
            memory: "512Mi"
            cpu:    "250m"
    volumeMounts:
    - name: workspace-volume
      mountPath: /home/jenkins/agent
  - name: kaniko
    image: gcr.io/kaniko-project/executor:debug
    command:
    - sleep
    args:
    - infinity
    resources:
        requests:
            memory: "512Mi"
            cpu:    "200m"
        limits:
            memory: "1Gi"
            cpu:    "500m"
    volumeMounts:
    - name: workspace-volume
      mountPath: /workspace
    - name: kaniko-secret
      mountPath: /kaniko/.docker
    workingDir: /workspace
  - name: gcloud
    image: google/cloud-sdk:latest
    command:
    - sleep
    args:
    - infinity
    resources:
        requests:
            memory: "128Mi"
            cpu:    "50m"
        limits:
            memory: "512Mi"
            cpu:    "250m"
    volumeMounts:
    - name: workspace-volume
      mountPath: /workspace
  volumes:
  - name: workspace-volume
    emptyDir: {}
  - name: kaniko-secret
    emptyDir: {}
  restartPolicy: Never
'''
        }
    }

    environment {
        PROJECT_ID                 = 'e-shop-deploy'
        GCR_REGISTRY               = 'gcr.io'
        BACKEND_IMAGE              = 'ecommerce-backend'
        FRONTEND_IMAGE             = 'ecommerce-frontend'
        USER_SERVICE_IMAGE         = 'user-service'
        PRODUCT_SERVICE_IMAGE      = 'product-service'
        TRANSACTION_SERVICE_IMAGE  = 'transaction-service'
        RECOMMENDATION_API_IMAGE   = 'recommendation-api'
        DOCKER_TAG                 = "${env.BUILD_NUMBER}"
        GCP_KEY                    = credentials('gcp-service-account-key')
        GCP_CREDENTIALS_ID         = 'gcp-service-account-key'
    }

    stages {
        stage('Checkout Code') {
            steps { 
                checkout scm 
                script {
                    echo "âœ… Source code checked out successfully"
                    sh '''
                        echo "=== WORKSPACE CONTENTS ==="
                        ls -la
                        echo "=== CHECKING REQUIRED DIRECTORIES ==="
                        ls -la e-commerce-master/ || echo "âŒ e-commerce-master not found"
                        ls -la e-commerce-front-master/ || echo "âŒ e-commerce-front-master not found"
                        ls -la recommendation-service/ || echo "âŒ recommendation-service not found"
                        echo "=== CHECKING DOCKERFILES ==="
                        find . -name "Dockerfile*" -type f
                    '''
                }
            }
        }

        stage('Security Scan - Secrets') {
            steps {
                script {
                    echo "ðŸ” Running secret scanning (placeholder)"
                }
            }
        }     

        stage('Setup Kaniko Authentication') {
            steps {
                container('kaniko') {               
                    withCredentials([file(credentialsId: 'gcp-service-account-key', variable: 'GCP_SA_KEY')]) {
                        sh '''
                            echo "ðŸ”§ Setting up Kaniko authentication..."
                            
                            # Create the Docker config directory
                            mkdir -p /kaniko/.docker
                            
                            # Create proper Docker config for Kaniko
                            # First, activate the service account to get an access token
                            gcloud auth activate-service-account --key-file="$GCP_SA_KEY"
                            
                            # Get the access token
                            ACCESS_TOKEN=$(gcloud auth print-access-token)
                            
                            # Create the Docker config with OAuth token
                            cat > /kaniko/.docker/config.json << EOF
{
  "auths": {
    "gcr.io": {
      "auth": "$(echo -n "oauth2accesstoken:$ACCESS_TOKEN" | base64 -w 0)"
    }
  }
}
EOF
                            
                            echo "âœ… Kaniko authentication configured"
                            ls -la /kaniko/.docker/
                        '''
                    }
                }
            }
        }

        stage('Build Images') {
            steps {
                container('kaniko') {
                    script {
                        echo "ðŸ”¨ Building Docker images with Kaniko..."
                        sh '''
                            echo "=== VERIFYING KANIKO SETUP ==="
                            /kaniko/executor --help | head -5
                            ls -la /kaniko/.docker/config.json

                            echo "=== BUILDING BACKEND IMAGE ==="
                            if [ -d "e-commerce-master" ] && [ -f "e-commerce-master/Dockerfile.backend" ]; then
                                /kaniko/executor \
                                  --context="$(pwd)/e-commerce-master" \
                                  --dockerfile="$(pwd)/e-commerce-master/Dockerfile.backend" \
                                  --destination=${GCR_REGISTRY}/${PROJECT_ID}/${BACKEND_IMAGE}:${DOCKER_TAG} \
                                  --destination=${GCR_REGISTRY}/${PROJECT_ID}/${BACKEND_IMAGE}:latest \
                                  --cache=true \
                                  --cleanup
                                echo "âœ… Backend image built successfully"
                            else
                                echo "âŒ Backend Dockerfile not found"
                                exit 1
                            fi

                            echo "=== BUILDING FRONTEND IMAGE ==="
                            if [ -d "e-commerce-front-master" ] && [ -f "e-commerce-front-master/dockerfile.frontend" ]; then
                                /kaniko/executor \
                                  --context="$(pwd)/e-commerce-front-master" \
                                  --dockerfile="$(pwd)/e-commerce-front-master/dockerfile.frontend" \
                                  --destination=${GCR_REGISTRY}/${PROJECT_ID}/${FRONTEND_IMAGE}:${DOCKER_TAG} \
                                  --destination=${GCR_REGISTRY}/${PROJECT_ID}/${FRONTEND_IMAGE}:latest \
                                  --cache=true \
                                  --cleanup
                                echo "âœ… Frontend image built successfully"
                            else
                                echo "âŒ Frontend Dockerfile not found"
                                exit 1
                            fi

                            echo "=== BUILDING RECOMMENDATION API ==="
                            if [ -d "recommendation-service" ] && [ -f "recommendation-service/Dockerfile" ]; then
                                /kaniko/executor \
                                  --context="$(pwd)/recommendation-service" \
                                  --dockerfile="$(pwd)/recommendation-service/Dockerfile" \
                                  --destination=${GCR_REGISTRY}/${PROJECT_ID}/${RECOMMENDATION_API_IMAGE}:${DOCKER_TAG} \
                                  --destination=${GCR_REGISTRY}/${PROJECT_ID}/${RECOMMENDATION_API_IMAGE}:latest \
                                  --cache=true \
                                  --cleanup
                                echo "âœ… Recommendation API image built successfully"
                            else
                                echo "âŒ Recommendation API Dockerfile not found"
                                exit 1
                            fi

                            echo "=== BUILDING USER SERVICE ==="
                            if [ -f "e-commerce-master/Dockerfile.user" ]; then
                                /kaniko/executor \
                                  --context="$(pwd)/e-commerce-master" \
                                  --dockerfile="$(pwd)/e-commerce-master/Dockerfile.user" \
                                  --destination=${GCR_REGISTRY}/${PROJECT_ID}/${USER_SERVICE_IMAGE}:${DOCKER_TAG} \
                                  --destination=${GCR_REGISTRY}/${PROJECT_ID}/${USER_SERVICE_IMAGE}:latest \
                                  --cache=true \
                                  --cleanup
                                echo "âœ… User service image built successfully"
                            else
                                echo "âŒ User service Dockerfile not found"
                                exit 1
                            fi

                            echo "=== BUILDING PRODUCT SERVICE ==="
                            if [ -f "e-commerce-master/Dockerfile.product" ]; then
                                /kaniko/executor \
                                  --context="$(pwd)/e-commerce-master" \
                                  --dockerfile="$(pwd)/e-commerce-master/Dockerfile.product" \
                                  --destination=${GCR_REGISTRY}/${PROJECT_ID}/${PRODUCT_SERVICE_IMAGE}:${DOCKER_TAG} \
                                  --destination=${GCR_REGISTRY}/${PROJECT_ID}/${PRODUCT_SERVICE_IMAGE}:latest \
                                  --cache=true \
                                  --cleanup
                                echo "âœ… Product service image built successfully"
                            else
                                echo "âŒ Product service Dockerfile not found"
                                exit 1
                            fi

                            echo "=== BUILDING TRANSACTION SERVICE ==="
                            if [ -f "e-commerce-master/Dockerfile.transaction" ]; then
                                /kaniko/executor \
                                  --context="$(pwd)/e-commerce-master" \
                                  --dockerfile="$(pwd)/e-commerce-master/Dockerfile.transaction" \
                                  --destination=${GCR_REGISTRY}/${PROJECT_ID}/${TRANSACTION_SERVICE_IMAGE}:${DOCKER_TAG} \
                                  --destination=${GCR_REGISTRY}/${PROJECT_ID}/${TRANSACTION_SERVICE_IMAGE}:latest \
                                  --cache=true \
                                  --cleanup
                                echo "âœ… Transaction service image built successfully"
                            else
                                echo "âŒ Transaction service Dockerfile not found"
                                exit 1
                            fi

                            echo "ðŸŽ‰ All images built successfully!"
                        '''
                    }
                }
            }
        }

        stage('Deploy to GKE') {
            steps {
                container('gcloud') {
                    script {
                        withCredentials([file(credentialsId: 'gcp-service-account-key', variable: 'GCP_SA_KEY')]) {
                            sh '''
                                echo "ðŸ”§ Setting up GCloud authentication..."
                                export GOOGLE_APPLICATION_CREDENTIALS="$GCP_SA_KEY"
                                gcloud auth activate-service-account --key-file="$GOOGLE_APPLICATION_CREDENTIALS"
                                gcloud container clusters get-credentials ecommerce-cluster --zone=europe-west1-b --project=$PROJECT_ID

                                echo "ðŸ“¥ Downloading Kubernetes manifests from GCS..."
                                mkdir -p /tmp/k8s-manifests/deployments
                                mkdir -p /tmp/k8s-manifests/services

                                gsutil -m cp -r gs://e-shop-bucket-1/k8s/deployments/* /tmp/k8s-manifests/deployments/
                                gsutil -m cp -r gs://e-shop-bucket-1/k8s/services/* /tmp/k8s-manifests/services/

                                echo "ðŸ”„ Updating image tags in deployments..."
                                find /tmp/k8s-manifests/deployments -name "*.yaml" -o -name "*.yml" | xargs sed -i "s|:latest|:${BUILD_NUMBER}|g"

                                echo "ðŸš€ Applying Kubernetes Deployments..."
                                kubectl apply -f /tmp/k8s-manifests/deployments/

                                echo "ðŸš€ Applying Kubernetes Services..."
                                kubectl apply -f /tmp/k8s-manifests/services/

                                echo "â³ Waiting for deployments to be ready..."
                                kubectl rollout status deployment --all --timeout=300s

                                echo "âœ… Deployment completed successfully!"
                            '''
                        }
                    }
                }
            }
        }
    }

    post {
        always  { 
            echo "ðŸ§¹ Cleaning upâ€¦"
        }
        success { echo "âœ… Pipeline completed successfully!" }
        failure { echo "âŒ Pipeline failed. Check logs above for details." }
    }
}